# 宝塔面板 (Baota Panel) 部署指南

由于本项目采用了前后端分离且可以通过依赖引用的结构（后端需引用前端目录下的资源），部署时需要注意保持目录结构完整。

## 1. 准备工作

### 1.1 确认目录结构
确保你上传到服务器的目录结构如下（建议整个项目文件夹上传）：

```text
/www/wwwroot/iot-project/  <-- 项目根目录
├── backend/               <-- 后端代码
├── frontend/              <-- 前端代码（包含 backend 需要的 metadata.json 和 sounds）
└── mind+/                 <-- (可选)
```

> **注意**：后端代码中使用了相对路径 `../frontend` 来读取音频和配置文件，因此**必须**确保 `backend` 和 `frontend` 在同一个父目录下。

## 2. 部署后端 (Node.js)

### 2.1 安装 Node.js 环境
1. 登录宝塔面板。
2. 进入 **网站 (Website)** -> **Node 项目 (Node project)** (如果没有此选项，请在软件商店安装 "Node.js 版本管理器" 和 "PM2 管理器")。
3. 确保安装了 Node.js 18+ 版本。

### 2.2 添加 Node 项目
1. 点击 **添加 Node 项目**。
2. **项目目录**: 选择 `/www/wwwroot/iot-project/backend`。
3. **启动选项**:
   - **启动脚本**: 选择 `start` (对应 `package.json` 中的 `npm run start`) 或直接填写 `server.js`。
   - **自定义命令**: 如果需要指定命令，可以使用 `node server.js`。
4. **项目名称**: 填写 `iot-backend` (或其他你喜欢的名字)。
5. **项目端口**: 填写 `3002` (或你想要的其他端口，记得在安全组放行)。
6. **运行用户**: 建议使用 `www`。
7. **环境**: 选择 Node v18+。

### 2.3 配置环境变量 (可选)
如果需要自定义 Key 或端口，可以在项目配置中添加环境变量：
- `PORT`: 3002
- `API_KEY`: 你的密钥 (默认 `iot-secret`)

### 2.4 安装依赖并启动
1. 提交后，点击项目右侧的 **模块 (Modules)** 或 **依赖**，确保安装了依赖 (宝塔通常会自动运行 `npm install`)。如果没安装，请手动进入目录执行 `npm install`。
2. 确保项目状态为 **运行中 (Running)**。

## 3. 部署前端 (静态站点)

### 3.1 构建前端
在本地开发机上执行构建命令：
```bash
npm --prefix frontend run build
```
这将在 `frontend/dist` 生成静态文件。

### 3.2 上传静态文件
你可以选择以下两种方式之一：
1. **(推荐) Nginx 纯静态托管**:
   - 在宝塔 **网站** -> **PHP/HTML 项目** 中添加站点。
   - **根目录** 指向 `/www/wwwroot/iot-project/frontend/dist` (你需要把本地 build 好的 `dist` 文件夹上传上去，或者在服务器上运行 build)。
   - **注意**: 由于后端依赖 `frontend/public` 下的资源，建议把源码上传到服务器，在服务器构建，或者确保上传结构完整。

2. **(简单) 直接部署 dist**:
   - 如果你只上传了 `frontend/dist` 到服务器某个目录，确保后端还能找到 `../frontend/public` 里的资源（这可能比较麻烦，所以建议**方法1：上传完整源码结构**）。

### 3.3 配置反向代理 (解决跨域与端口问题)
为了方便访问，可以在前端站点的 Nginx 配置中添加反向代理，将 `/api` 请求转发给后端。

在前端站点的 **配置文件** 或 **反向代理** 设置中：
- **代理名称**: API
- **目标 URL**: `http://127.0.0.1:3002`
- **发送域名**: `$host`

这样前端代码里的 API 地址就可以写成当前域名，无需担心端口问题。

## 4. 常见问题与故障排除

### 4.1 错误提示：项目依赖安装异常
如果宝塔提示“项目依赖安装异常，请先到模块管理中重新安装依赖后再试!”，通常是因为宝塔自动运行 `npm install` 失败（可能是网络超时或权限问题）。

**解决方法：使用终端手动安装**

1. 在宝塔面板左侧菜单点击 **终端 (Terminal)**。
2. 输入 SSH 密码登录（或使用密钥）。
3. 进入后端目录（根据你的实际路径）：
   ```bash
   cd /www/wwwroot/iot-project/backend
   ```
4. 如果是为了国内加速，可以临时使用淘宝镜像安装：
   ```bash
   npm install --registry=https://registry.npmmirror.com
   ```
   或者直接运行：
   ```bash
   npm install
   ```
5. 安装完成后，回到 **Node 项目** 界面，尝试重新启动项目。如果不成功，可以先删除该 Node 项目记录（不删文件），然后重新添加，此时宝塔会检测到 `node_modules` 已存在。

### 4.2 启动后立即停止或报错
- **检查日志**: 点击项目右侧的 **日志 (Logs)** 查看具体报错。
- **路径错误**: 如果日志提示 `ENOENT` 或 `Access denied` 访问 `../frontend/metadata.json` 等文件，请检查：
  - 是否上传了 `frontend` 文件夹？
  - `backend` 和 `frontend` 是否在同一级目录？
  - 运行用户（如 `www`）是否有权限访问 `frontend` 目录？（可以尝试在终端运行 `chown -R www:www /www/wwwroot/iot-project/` 修复权限）。

### 4.3 特殊情况：无依赖导致报错
由于本项目的 `backend` 极其精简，没有第三方依赖（`package.json` 中 `dependencies` 为空），某些版本的宝塔面板会错误地认为依赖安装失败（因为它找不到 `node_modules` 文件夹）。

**解决方法**：
1. **手动创建 node_modules**：
   在终端中进入 backend 目录，手动创建一个空文件夹：
   ```bash
   mkdir node_modules
   ```
2. **或者安装一个辅助包**：
   如果方法 1 无效，可以随便安装一个包来“骗”过检查：
   ```bash
   npm install cross-env --save
   ```
   安装后再次尝试启动。

### 4.4 错误提示：EADDRINUSE (端口被占用)
如果日志显示 `Error: listen EADDRINUSE: address already in use :::3002`，说明端口 3002 已经被占用。这通常是因为之前的启动尝试虽然报错（如依赖检查失败），但后台进程实际上已经启动了。

**解决方法**：
1. **查找占用端口的进程**：
   在终端运行：
   ```bash
   lsof -i :3002
   ```
   或者：
   ```bash
   netstat -tunlp | grep 3002
   ```
2. **杀掉进程**：
   找到 PID (比如 `12345`)，然后运行：
   ```bash
   kill -9 12345
   ```
3. **或者直接一键杀掉所有 node 进程** (慎用，会停止所有 Node 项目)：
   ```bash
   pkill node
   ```
4. **重启项目**：
   回到 Node 项目管理界面重新启动。

### 4.5 修改端口提示
如果你在宝塔配置中将项目端口改为了 `3002`：
1. **确保代码生效**：你的后端代码会读取 `PORT` 环境变量，所以只要宝塔传了该变量，后端就会监听 3002。
2. **修改反向代理**：务必在前端站点的 **反向代理** 设置中，将 **目标 URL** 修改为 `http://127.0.0.1:3002`。
3. **或者修改前端配置**：如果不使用反向代理而是直接访问 API，需要修改 `frontend/src/constants.ts` (如果有) 或相关配置中的 API 地址为 `:3002`，并重新构建前端。
